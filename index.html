<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Diário – Gestão de Pedidos</title>
  <style>
    :root{
      --bg0:#060913;
      --bg1:#0b1020;

      --card:#11162a;
      --card2:#0f1530;
      --border:#1f2a44;

      --muted:#9aa4bf;
      --text:#eef1ff;

      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --accent:#38bdf8;

      --radius:14px;
      --gap:14px;
      --headerH:58px;
      --rowH:34px;
      --padX:18px;
      --padY:14px;

      /* left area sizing */
      --leftW: 520px;
    }

    *{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Arial, sans-serif; }

    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(56,189,248,.14), transparent 55%),
        radial-gradient(1000px 650px at 85% -20%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    /* HEADER */
    header{
      height:var(--headerH);
      padding:0 var(--padX);
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
      background: rgba(6,9,19,.65);
      backdrop-filter: blur(8px);
    }

    header h1{
      margin:0;
      font-size:16px;
      font-weight:800;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:65vw;
    }

    header .meta{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    header .meta strong{ color:var(--text); font-weight:750; }

    /* APP GRID */
    main{
      height: calc(100vh - var(--headerH));
      padding: var(--padY) var(--padX);
      display:grid;
      grid-template-rows: auto 1fr;
      gap: var(--gap);
      overflow:hidden;
    }

    /* KPI STRIP — maior */
    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--gap);
    }

    .kpi{
      background:
        radial-gradient(900px 200px at 20% -20%, rgba(56,189,248,.20), transparent 55%),
        linear-gradient(180deg, rgba(56,189,248,.08), transparent 45%),
        var(--card);
      border:1px solid rgba(56,189,248,.18);
      border-radius: 18px;
      padding: 14px 14px;
      min-width:0;
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
    }

    .kpi .label{
      font-size:12px;
      color:rgba(238,241,255,.72);
      font-weight:750;
      letter-spacing:.15px;
    }

    .kpi .value{
      margin-top:10px;
      font-size:26px;
      font-weight:900;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .good{ color:var(--good); }
    .warn{ color:var(--warn); }
    .bad{ color:var(--bad); }

    /* BODY LAYOUT */
    .layout{
      display:grid;
      grid-template-columns: var(--leftW) 1fr;
      gap: var(--gap);
      min-height:0;
      overflow:hidden;
    }

    .leftStack{
      display:grid;
      grid-template-rows: 1fr auto; /* Gestão de pedidos (cresce) + Faturamento 5d (auto) */
      gap: var(--gap);
      min-height:0;
      overflow:hidden;
    }

    .rightStack{
      display:grid;
      grid-template-columns: 1.20fr .95fr;
      gap: var(--gap);
      min-height:0;
      overflow:hidden;
    }

    /* CARDS (dark) */
    .card{
      background: rgba(17,22,42,.92);
      border:1px solid rgba(31,42,68,.85);
      border-radius: var(--radius);
      padding: 10px 12px;
      display:flex;
      flex-direction:column;
      min-height:0;
      overflow:hidden;
    }

    .cardHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-bottom:10px;
      border-bottom:1px solid rgba(31,42,68,.75);
      margin-bottom:10px;
      min-width:0;
    }

    .cardTitle{
      font-size:12px;
      font-weight:900;
      color: rgba(238,241,255,.70);
      text-transform: uppercase;
      letter-spacing: .35px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .badge{
      font-size:11px;
      font-weight:850;
      color: var(--text);
      background: rgba(56,189,248,.12);
      border: 1px solid rgba(56,189,248,.22);
      padding: 5px 10px;
      border-radius: 999px;
      white-space:nowrap;
    }

    .badge.bad{ background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.25); }
    .badge.warn{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.25); }
    .badge.good{ background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.25); }

    /* SOFT PULSE (pisca-pisca suave) */
    @keyframes softPulse {
      0%   { box-shadow: 0 0 0 rgba(239,68,68,.0); filter: brightness(1); }
      50%  { box-shadow: 0 0 22px rgba(239,68,68,.18); filter: brightness(1.05); }
      100% { box-shadow: 0 0 0 rgba(239,68,68,.0); filter: brightness(1); }
    }

    .pulseRisk{
      animation: softPulse 2.8s ease-in-out infinite;
    }

    /* TOOLBAR (ordenar) */
    .toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:-2px;
      margin-bottom:10px;
    }

    .toolbar .left{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }

    .toolbar label{
      font-size:11px;
      color: rgba(238,241,255,.70);
      font-weight:900;
      letter-spacing:.2px;
      text-transform: uppercase;
      white-space:nowrap;
    }

    .toolbar select{
      background: rgba(15,21,48,.95);
      border:1px solid rgba(31,42,68,.95);
      color: var(--text);
      border-radius: 12px;
      padding: 7px 10px;
      font-size:12px;
      outline:none;
    }

    .btn{
      background: rgba(56,189,248,.14);
      border: 1px solid rgba(56,189,248,.25);
      color: var(--text);
      border-radius: 12px;
      padding: 7px 10px;
      font-size:12px;
      font-weight:850;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn:hover{ filter: brightness(1.08); }

    /* TABLES (dark) */
    .tableWrap{
      border:1px solid rgba(31,42,68,.90);
      border-radius: 12px;
      overflow:auto;
      background: rgba(15,21,48,.94);
      min-height:0;
    }

    .tableWrap.noScroll{
      overflow:hidden; /* sem barra de rolagem */
    }

    table{
      width:100%;
      border-collapse: collapse;
      font-size:12px;
    }

    th, td{
      padding: 7px 9px;
      height: var(--rowH);
      border-bottom: 1px solid rgba(31,42,68,.80);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      vertical-align: middle;
    }

    th{
      text-align:left;
      color: rgba(238,241,255,.70);
      font-weight:900;
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(15,21,48,.98);
      border-bottom: 1px solid rgba(31,42,68,.95);
    }

    /* ====== CARD BRANCO (STATUS DETALHADO) ====== */
    .cardLight{
      background:#ffffff;
      border: 0;
      border-radius: 16px;
      padding: 0;
      overflow:hidden;
      box-shadow: 0 16px 34px rgba(0,0,0,.26);
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    .lightTop{
      background: #ffffff;
      padding: 14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid #e6e7ea;
    }

    .lightTop .title{
      font-size: 18px;
      font-weight: 900;
      color:#0b1020;
    }

    .lightTop .pill{
      font-size: 12px;
      font-weight: 900;
      color:#0b1020;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      padding: 7px 12px;
      border-radius: 999px;
      white-space:nowrap;
    }

    .lightTableWrap{
      background:#ffffff;
      overflow:auto;
      min-height:0;
    }

    .lightTable{
      width:100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .lightTable thead th{
      background: #0b1020;
      color:#ffffff;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .35px;
      font-size: 12px;
      position: sticky;
      top: 0;
      z-index: 3;
      border-bottom: 0;
      height: 42px;
    }

    .lightTable td, .lightTable th{
      padding: 11px 12px;
      border-bottom: 1px solid #e5e7eb;
      height: 42px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color:#0b1020;
    }

    .lightTable tbody tr:nth-child(odd){ background:#f3f4f6; }
    .lightTable tbody tr:nth-child(even){ background:#efefea; }

    .rowGold{ background:#e8d7aa !important; }
    .rowGreenStrong{
      background:#bfe7cf !important;
    }
    .rowGreenStrong td{
      font-size: 14px;
      font-weight: 950;
    }

    .lightTable td.num{ text-align:center; font-weight:900; }
    .lightTable td.val{ text-align:right; font-weight:950; }

    /* FOOTER */
    .footer{
      margin-top: 10px;
      font-size: 11px;
      color: rgba(238,241,255,.55);
      text-align: right;
    }

    /* RESPONSIVO — notebook vira 1 coluna (menos confuso) */
    @media (max-width: 1400px){
      :root{
        --leftW: 1fr;
        --padX:14px;
        --padY:12px;
        --gap:12px;
      }
      .kpi .value{ font-size:24px; }
      .layout{ grid-template-columns: 1fr; }
      .rightStack{ grid-template-columns: 1fr; }
    }

    @media (max-width: 1100px){
      .kpis{ grid-template-columns: repeat(2, 1fr); }
      .kpi .value{ font-size:22px; }
      header h1{ max-width:55vw; }
      .footer{ text-align:left; }
    }
  </style>
</head>
<body>

<header>
  <h1>Painel Diário – Gestão de Pedidos</h1>
  <div class="meta">Atualizado em: <strong id="updatedAt">--/--/----</strong></div>
</header>

<main>

  <!-- KPIs (maiores) -->
  <section class="kpis">
    <div class="kpi">
      <div class="label">Pedidos Faturados Hoje</div>
      <div class="value good" id="kpiPedidosFaturados">0</div>
    </div>
    <div class="kpi">
      <div class="label">Valor Faturado Hoje</div>
      <div class="value good" id="kpiValorFaturado">R$ 0,00</div>
    </div>
    <div class="kpi">
      <div class="label">Pedidos em Aberto</div>
      <div class="value warn" id="kpiPedidosAbertos">0</div>
    </div>
    <div class="kpi">
      <div class="label">Valor em Risco (Crédito + Alvará + Bloqueio)</div>
      <div class="value bad" id="kpiValorRisco">R$ 0,00</div>
    </div>
  </section>

  <!-- CONTEÚDO -->
  <section class="layout">

    <!-- ESQUERDA -->
    <div class="leftStack">

      <!-- Gestão de pedidos (sobe) -->
      <section class="cardLight">
        <div class="lightTop">
          <div class="title">Gestão de Pedidos</div>
          <div class="pill" id="pillItens">0 itens</div>
        </div>
        <div class="lightTableWrap" aria-label="Tabela status detalhado">
          <table class="lightTable">
            <thead>
              <tr>
                <th style="width:56%">Pedidos</th>
                <th style="width:18%; text-align:center;">Quantidade</th>
                <th style="width:26%; text-align:right;">Valor</th>
              </tr>
            </thead>
            <tbody id="tblStatusDetalhadoLight"></tbody>
          </table>
        </div>
      </section>

      <!-- Faturamento (desce) — 5 dias, sem rolagem -->
      <section class="card">
        <div class="cardHeader">
          <div class="cardTitle">Faturamento – últimos 5 dias</div>
          <div class="badge" id="badgeFat5">5 dias</div>
        </div>
        <div class="tableWrap noScroll" aria-label="Tabela de faturamento 5 dias">
          <table>
            <thead>
              <tr><th style="width:38%">Data</th><th>Valor</th></tr>
            </thead>
            <tbody id="tblFaturamento5dias"></tbody>
          </table>
        </div>
      </section>

    </div>

    <!-- DIREITA: RISCO -->
    <section class="rightStack">

      <!-- Crédito (pisca suave) -->
      <section class="card pulseRisk" id="cardCredito">
        <div class="cardHeader">
          <div class="cardTitle">Risco – análise de crédito</div>
          <div class="badge bad" id="badgeCredito">0 pedidos</div>
        </div>

        <div class="toolbar">
          <div class="left">
            <label for="sortCreditoBy">Ordenar por</label>
            <select id="sortCreditoBy">
              <option value="valor">Valor</option>
              <option value="margem">Margem</option>
              <option value="data_pedido">Data</option>
              <option value="pedido">Pedido</option>
              <option value="cliente">Cliente</option>
            </select>
            <button class="btn" id="sortCreditoDir" title="Alternar direção">Desc ↓</button>
          </div>
          <button class="btn" id="refreshBtn" title="Recarregar data.json">Recarregar</button>
        </div>

        <div class="tableWrap" aria-label="Tabela análise de crédito">
          <table>
            <thead>
              <tr>
                <th style="width:12%">Pedido</th>
                <th style="width:14%">Data</th>
                <th>Cliente</th>
                <th style="width:10%">UF</th>
                <th style="width:16%">Valor</th>
                <th style="width:12%">Margem</th>
                <th style="width:18%">Vendedor</th>
              </tr>
            </thead>
            <tbody id="tblCredito"></tbody>
          </table>
        </div>
      </section>

      <!-- Bloqueios / Alvará (pisca suave) -->
      <section class="card pulseRisk" id="cardBloq">
        <div class="cardHeader">
          <div class="cardTitle">Risco – bloqueios / alvará</div>
          <div class="badge bad" id="badgeBloq">0 pedidos</div>
        </div>

        <div class="toolbar">
          <div class="left">
            <label for="sortBloqBy">Ordenar por</label>
            <select id="sortBloqBy">
              <option value="valor">Valor</option>
              <option value="margem">Margem</option>
              <option value="data_pedido">Data</option>
              <option value="pedido">Pedido</option>
              <option value="cliente">Cliente</option>
            </select>
            <button class="btn" id="sortBloqDir" title="Alternar direção">Desc ↓</button>
          </div>
          <div></div>
        </div>

        <div class="tableWrap" aria-label="Tabela bloqueios e alvará">
          <table>
            <thead>
              <tr>
                <th style="width:12%">Pedido</th>
                <th style="width:14%">Data</th>
                <th>Cliente</th>
                <th style="width:22%">Motivo</th>
                <th style="width:16%">Valor</th>
                <th style="width:12%">Margem</th>
                <th style="width:18%">Vendedor</th>
              </tr>
            </thead>
            <tbody id="tblBloqueiosAlvara"></tbody>
          </table>
        </div>
      </section>

    </section>

  </section>

  <div class="footer">Painel de uso gerencial – visão diária</div>
</main>

<script>
  // ====== Fallback (se data.json falhar) ======
  const dashboardDataFallback = {
    updated_at: "— (fallback)",
    kpis_dia: { pedidos_faturados: 0, valor_faturado: 0, pedidos_abertos: 0, valor_em_risco: 0 },
    faturamento_ultimos_3_dias: [],
    status_detalhado: [],
    analise_credito: [],
    bloqueios_alvara: []
  };

  // ====== ESTADO DE ORDENAÇÃO ======
  const sortState = {
    credito: { by: "valor", dir: "desc" },
    bloq: { by: "valor", dir: "desc" }
  };

  // ====== HELPERS ======
  const el = (id) => document.getElementById(id);

  const fmtBRL = (n) => (isFinite(n) ? n : 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  const fmtPct = (n) => `${(isFinite(n) ? n : 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}%`;

  function parseBRDate(d){
    // "DD/MM/YYYY" -> número comparável
    if(!d || typeof d !== "string") return 0;
    const m = d.trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(!m) return 0;
    const dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
    return yy*10000 + mm*100 + dd;
  }

  function normalizeText(s){
    return String(s ?? "")
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .toUpperCase().trim();
  }

  function rowHtml(cells){
    return `<tr>${cells.map(c => `<td title="${String(c).replaceAll('"','&quot;')}">${c}</td>`).join('')}</tr>`;
  }

  function sortArray(arr, by, dir){
    const factor = dir === "asc" ? 1 : -1;
    const copy = [...(arr || [])];

    const getter = (x) => {
      if(by === "valor") return Number(x.valor) || 0;
      if(by === "margem") return Number(x.margem) || 0;
      if(by === "data_pedido") return parseBRDate(x.data_pedido);
      if(by === "pedido") return Number(x.pedido) || 0;
      if(by === "cliente") return normalizeText(x.cliente);
      return 0;
    };

    copy.sort((a,b) => {
      const A = getter(a), B = getter(b);
      if(typeof A === "string" && typeof B === "string") return A.localeCompare(B) * factor;
      return (A === B ? 0 : (A > B ? 1 : -1)) * factor;
    });

    return copy;
  }

  // ====== RENDER ======
  function render(data){
    el('updatedAt').textContent = data.updated_at || '--/--/----';

    el('kpiPedidosFaturados').textContent = data.kpis_dia?.pedidos_faturados ?? 0;
    el('kpiValorFaturado').textContent = fmtBRL(data.kpis_dia?.valor_faturado ?? 0);
    el('kpiPedidosAbertos').textContent = data.kpis_dia?.pedidos_abertos ?? 0;
    el('kpiValorRisco').textContent = fmtBRL(data.kpis_dia?.valor_em_risco ?? 0);

    // ===== Faturamento (até 5 dias) =====
    // Suporta:
    // - faturamento_ultimos_3_dias (se vier com 5 linhas, mostra 5)
    // - futuramente faturamento_ultimos_5_dias (se você quiser renomear)
    const faturamento = (data.faturamento_ultimos_5_dias || data.faturamento_ultimos_3_dias || []);
    const fat5 = faturamento.slice(-5);

    const fatBody = el('tblFaturamento5dias');
    fatBody.innerHTML = fat5
      .map(x => rowHtml([x.data, fmtBRL(x.valor)])).join('') || rowHtml(['—', fmtBRL(0)]);

    // ===== Status detalhado (card branco) =====
    const status = (data.status_detalhado || []);
    el('pillItens').textContent = `${status.length} itens`;

    const tbodyLight = el('tblStatusDetalhadoLight');
    tbodyLight.innerHTML = status.map(x => {
      const st = String(x.status ?? "");
      const stN = normalizeText(st);

      // Destaques pedidos:
      // - FATURADO: sem cor
      // - TOTAL FATURAMENTO PREVISTO: destaque forte
      // - TOTAL EM DISPUTA: mantém dourado (como referência)
      let cls = "";
      if(stN === "TOTAL EM DISPUTA") cls = "rowGold";
      if(stN === "TOTAL FATURAMENTO PREVISTO") cls = "rowGreenStrong";

      const qtd = Number(x.quantidade) || 0;
      const val = fmtBRL(Number(x.valor) || 0);

      return `
        <tr class="${cls}">
          <td>${st}</td>
          <td class="num">${qtd}</td>
          <td class="val">${val}</td>
        </tr>
      `;
    }).join('') || `
      <tr><td>—</td><td class="num">0</td><td class="val">${fmtBRL(0)}</td></tr>
    `;

    // ===== Crédito (ordenável) =====
    const creditoSorted = sortArray(data.analise_credito || [], sortState.credito.by, sortState.credito.dir);
    const credBody = el('tblCredito');
    credBody.innerHTML = creditoSorted.map(x => rowHtml([
      x.pedido ?? "—",
      x.data_pedido ?? "—",
      x.cliente ?? "—",
      x.uf ?? "—",
      fmtBRL(x.valor),
      fmtPct(x.margem),
      x.vendedor ?? "—"
    ])).join('') || rowHtml(['—','—','—','—',fmtBRL(0),fmtPct(0),'—']);
    el('badgeCredito').textContent = `${(data.analise_credito||[]).length} pedidos`;

    // ===== Bloqueios/Alvará (ordenável) =====
    const bloqSorted = sortArray(data.bloqueios_alvara || [], sortState.bloq.by, sortState.bloq.dir);
    const bloqBody = el('tblBloqueiosAlvara');
    bloqBody.innerHTML = bloqSorted.map(x => rowHtml([
      x.pedido ?? "—",
      x.data_pedido ?? "—",
      x.cliente ?? "—",
      x.motivo ?? "—",
      fmtBRL(x.valor),
      fmtPct(x.margem),
      x.vendedor ?? "—"
    ])).join('') || rowHtml(['—','—','—','—',fmtBRL(0),fmtPct(0),'—']);
    el('badgeBloq').textContent = `${(data.bloqueios_alvara||[]).length} pedidos`;

    // ===== Pisca suave só quando houver risco =====
    const hasCredito = (data.analise_credito || []).length > 0;
    const hasBloq = (data.bloqueios_alvara || []).length > 0;
    el('cardCredito').classList.toggle('pulseRisk', hasCredito);
    el('cardBloq').classList.toggle('pulseRisk', hasBloq);
  }

  // ====== LOAD JSON EXTERNO ======
  async function loadData(){
    try{
      const r = await fetch('./data.json?v=' + Date.now());
      if(!r.ok) throw new Error('HTTP ' + r.status);
      const data = await r.json();
      window.__dashboardData = data; // guarda pra reordenar sem novo fetch
      render(data);
    }catch(err){
      console.error('Falha ao carregar ./data.json:', err);
      window.__dashboardData = dashboardDataFallback;
      render(dashboardDataFallback);
    }
  }

  // ====== UI: ORDENAÇÃO ======
  function toggleDir(btnId, key){
    const btn = el(btnId);
    sortState[key].dir = (sortState[key].dir === "desc") ? "asc" : "desc";
    btn.textContent = sortState[key].dir === "desc" ? "Desc ↓" : "Asc ↑";
    render(window.__dashboardData || dashboardDataFallback);
  }

  function setBy(selectId, key){
    const sel = el(selectId);
    sortState[key].by = sel.value;
    render(window.__dashboardData || dashboardDataFallback);
  }

  // Binds
  el('sortCreditoBy').addEventListener('change', () => setBy('sortCreditoBy', 'credito'));
  el('sortBloqBy').addEventListener('change', () => setBy('sortBloqBy', 'bloq'));
  el('sortCreditoDir').addEventListener('click', () => toggleDir('sortCreditoDir', 'credito'));
  el('sortBloqDir').addEventListener('click', () => toggleDir('sortBloqDir', 'bloq'));
  el('refreshBtn').addEventListener('click', loadData);

  // Init
  loadData();
</script>

</body>
</html>
